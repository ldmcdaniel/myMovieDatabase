/*------ Global Variables -------*/

"use strict";

var API_URL = "http://www.omdbapi.com/?t=";
var FIREBASE_URL = "https://nssmovies.firebaseio.com/";
var fb = new Firebase(FIREBASE_URL);
var movies;
$(".addMovie").hide();

/*------ Lookup a Movie -------*/

$(".submit").click(function () {
  var $movieSeachField = $(".movie");
  var $submitButton = $(".submit");
  $movieSeachField.prop("disabled", true);
  $submitButton.attr("disabled", true).html("Searching...");
  $(".movie-info").html("");
  $(".movie-poster").html("");
  var $input = $movieSeachField.val().split(" ").join("+");
  var url = API_URL + $input + "&y=&plot=short&r=json";
  $.get(url, function (data) {
    $(".movie-info").append("<h2 class='title'>\"" + data.Title + "\"</h2><h3 class='rating'>" + data.Rated + "</h3").append("<hr>").append("<h4>Plot: " + data.Plot + "</h4>").append("<h5>Actors: " + data.Actors + "</h5>").append("<h5>Genre: " + data.Genre + "</h5>").append("<h5>Released on " + data.Released + "</h5>").append("<h5>IMDB Rating: " + data.imdbRating + "</h5>");
    $(".movie-poster").append("<img src='" + data.Poster + "'</img>");
    $(".addMovie").show();
    $movieSeachField.prop("disabled", false);
    $submitButton.attr("disabled", false).html("Enter Movie Title");
  }); //End of .get request
}); //End of submit.click function

/*------ Add to Firebase & Table -------*/

$(".addMovie").click(function () {
  var $input = $(".movie").val().split(" ").join("+");
  var url = API_URL + $input + "&y=&plot=short&r=json";
  var postUrl = fb.child("users/" + fb.getAuth().uid + "/movies");
  $.get(url, function (data) {
    postUrl.push(data);
    $('input[type="text"]').val('');
  });
});

/*------ Syncing previous movie table -------*/

fb.onAuth(function (authData) {
  if (authData && authData.password.isTemporaryPassword) {
    window.location = '/reset_password.html';
  } else if (authData) {
    var postUrl = fb.child("users/" + fb.getAuth().uid + "/movies");
    postUrl.on("child_added", function (snapshot) {
      addMovieData(snapshot.val(), snapshot.key());
    });
  }
});

function addMovieData(data, id) {
  $(".movie-collection").prepend("<tr></tr>");
  var $target = $(".movie-collection tr:first").attr("data-id", id).append("<td><img src='" + data.Poster + "' class='poster'></td>").append("<td>" + data.Title + "</td>").append("<td>" + data.Year + "</td>").append("<td>" + data.Rated + "</td>").append("</td><td><button type='text' class='btn btn-warning delete'>Remove</button></td></tr>");
}

/*------ Delete data from Firebase & Table -------*/

$(".movie-collection").on('click', ".delete", function () {
  var $mov = $(this).closest('tr');
  var id = $mov.attr('data-id');
  $mov.remove();
  var deleteUrl = fb.child("users/" + fb.getAuth().uid + "/movies/" + id);
  deleteUrl.remove();
});

/*------ Register new user -------*/

$('.register').click(function () {
  var email = $('.login-welcome input[type="email"]').val();
  var password = $('.login-welcome input[type="password"]').val();
  fb.createUser({
    email: email,
    password: password
  }, function (err, userData) {
    if (err) {
      alert(err.toString());
    } else {
      doLogin(email, password);
    }
  });
  event.preventDefault();
});

/*------ Login to Database -------*/

$('.login-welcome form').submit(function () {
  var email = $('.login-welcome input[type="email"]').val();
  var password = $('.login-welcome input[type="password"]').val();

  doLogin(email, password);
  event.preventDefault();
});

/*------ Logout of Database -------*/

$('.logout').click(function () {
  window.location = '/';
  fb.unauth();
});

/*------ Reset password -------*/

$('.reset-password').click(function () {
  var email = $('.login-welcome input[type="email"]').val();
  fb.resetPassword({
    email: email
  }, function (err) {
    if (err) {
      alert(err.toString());
    } else {
      alert('Check your email!');
      window.location = '/reset_password.html';
    }
  });
});

/*------ Reset password -------*/

$('.to-reset-password form').submit(function () {
  var email = fb.getAuth().password.email;
  var oldPw = $('.to-reset-password input:nth-child(1)').val();
  var newPw = $('.to-reset-password input:nth-child(2)').val();

  fb.changePassword({
    email: email,
    oldPassword: oldPw,
    newPassword: newPw
  }, function (err) {
    if (err) {
      alert(err.toString());
    } else {
      fb.unauth();
      window.location = '/';
    }
  });

  event.preventDefault();
});

$(".cancel").click(function () {
  window.location = '/login.html';
});

/*------ Functions -------*/

function doLogin(email, password, cb) {
  fb.authWithPassword({
    email: email,
    password: password
  }, function (err, authData) {
    if (err) {
      alert(err.toString());
    } else {
      window.location = '/home.html';
      saveAuthData(authData);
      typeof cb === 'function' && cb(authData);
    }
  });
}

function saveAuthData(authData) {
  var ref = fb.child("users/" + authData.uid + "/profile");
  ref.set(authData);
}

function clearLoginForm() {
  $('input[type="email"]').val('');
  $('input[type="password"]').val('');
}
//# sourceMappingURL=data:application/json;base64,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QUFZLENBQUM7QUFDL0Isa0JBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUN2QixhQUFPLEVBQUUsS0FBSyxVQUFVLElBQUksRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0tBQzFDO0dBQ0YsQ0FBQyxDQUFDO0NBQ0o7O0FBRUQsU0FBUyxZQUFZLENBQUMsUUFBUSxFQUFFO0FBQzlCLE1BQUksR0FBRyxHQUFHLEVBQUUsQ0FBQyxLQUFLLFlBQVUsUUFBUSxDQUFDLEdBQUcsY0FBVyxDQUFDO0FBQ3BELEtBQUcsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7Q0FDbkI7O0FBRUQsU0FBUyxjQUFjLEdBQUk7QUFDekIsR0FBQyxDQUFDLHFCQUFxQixDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ2pDLEdBQUMsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztDQUNyQyIsImZpbGUiOiJtYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyotLS0tLS0gR2xvYmFsIFZhcmlhYmxlcyAtLS0tLS0tKi9cblxudmFyIEFQSV9VUkwgPSBcImh0dHA6Ly93d3cub21kYmFwaS5jb20vP3Q9XCI7XG52YXIgRklSRUJBU0VfVVJMID0gXCJodHRwczovL25zc21vdmllcy5maXJlYmFzZWlvLmNvbS9cIjtcbnZhciBmYiA9IG5ldyBGaXJlYmFzZShGSVJFQkFTRV9VUkwpO1xudmFyIG1vdmllcztcbiQoXCIuYWRkTW92aWVcIikuaGlkZSgpO1xuXG4vKi0tLS0tLSBMb29rdXAgYSBNb3ZpZSAtLS0tLS0tKi9cblxuJChcIi5zdWJtaXRcIikuY2xpY2soZnVuY3Rpb24oKSB7XG4gIHZhciAkbW92aWVTZWFjaEZpZWxkID0gJChcIi5tb3ZpZVwiKTtcbiAgdmFyICRzdWJtaXRCdXR0b24gPSAgJChcIi5zdWJtaXRcIik7XG4gICRtb3ZpZVNlYWNoRmllbGQucHJvcChcImRpc2FibGVkXCIsIHRydWUpO1xuICAkc3VibWl0QnV0dG9uLmF0dHIoXCJkaXNhYmxlZFwiLCB0cnVlKS5odG1sKFwiU2VhcmNoaW5nLi4uXCIpO1xuICAkKFwiLm1vdmllLWluZm9cIikuaHRtbChcIlwiKTtcbiAgJChcIi5tb3ZpZS1wb3N0ZXJcIikuaHRtbChcIlwiKTtcbiAgdmFyICRpbnB1dCA9ICRtb3ZpZVNlYWNoRmllbGRcbiAgICAudmFsKClcbiAgICAuc3BsaXQoXCIgXCIpXG4gICAgLmpvaW4oXCIrXCIpO1xuICB2YXIgdXJsID0gQVBJX1VSTCArICRpbnB1dCArIFwiJnk9JnBsb3Q9c2hvcnQmcj1qc29uXCI7XG4gICQuZ2V0KHVybCwgZnVuY3Rpb24oZGF0YSkge1xuICAgICQoXCIubW92aWUtaW5mb1wiKVxuICAgICAgLmFwcGVuZChcIjxoMiBjbGFzcz0ndGl0bGUnPlxcXCJcIiArIGRhdGEuVGl0bGUgKyBcIlxcXCI8L2gyPjxoMyBjbGFzcz0ncmF0aW5nJz5cIiArIGRhdGEuUmF0ZWQgKyBcIjwvaDNcIilcbiAgICAgIC5hcHBlbmQoXCI8aHI+XCIpXG4gICAgICAuYXBwZW5kKFwiPGg0PlBsb3Q6IFwiICsgZGF0YS5QbG90ICsgXCI8L2g0PlwiKVxuICAgICAgLmFwcGVuZChcIjxoNT5BY3RvcnM6IFwiICsgZGF0YS5BY3RvcnMgKyBcIjwvaDU+XCIpXG4gICAgICAuYXBwZW5kKFwiPGg1PkdlbnJlOiBcIiArIGRhdGEuR2VucmUgKyBcIjwvaDU+XCIpXG4gICAgICAuYXBwZW5kKFwiPGg1PlJlbGVhc2VkIG9uIFwiICsgZGF0YS5SZWxlYXNlZCArIFwiPC9oNT5cIilcbiAgICAgIC5hcHBlbmQoXCI8aDU+SU1EQiBSYXRpbmc6IFwiICsgZGF0YS5pbWRiUmF0aW5nICsgXCI8L2g1PlwiKVxuICAgICQoXCIubW92aWUtcG9zdGVyXCIpXG4gICAgICAuYXBwZW5kKFwiPGltZyBzcmM9J1wiICsgZGF0YS5Qb3N0ZXIgKyBcIic8L2ltZz5cIik7XG4gICAgJChcIi5hZGRNb3ZpZVwiKS5zaG93KCk7XG4gICAgJG1vdmllU2VhY2hGaWVsZC5wcm9wKFwiZGlzYWJsZWRcIiwgZmFsc2UpO1xuICAgICRzdWJtaXRCdXR0b24uYXR0cihcImRpc2FibGVkXCIsIGZhbHNlKS5odG1sKFwiRW50ZXIgTW92aWUgVGl0bGVcIik7XG4gIH0pLy9FbmQgb2YgLmdldCByZXF1ZXN0XG59KS8vRW5kIG9mIHN1Ym1pdC5jbGljayBmdW5jdGlvblxuXG4vKi0tLS0tLSBBZGQgdG8gRmlyZWJhc2UgJiBUYWJsZSAtLS0tLS0tKi9cblxuJChcIi5hZGRNb3ZpZVwiKS5jbGljayhmdW5jdGlvbigpIHtcbiAgdmFyICRpbnB1dCA9ICQoXCIubW92aWVcIikudmFsKCkuc3BsaXQoXCIgXCIpLmpvaW4oXCIrXCIpO1xuICB2YXIgdXJsID0gQVBJX1VSTCArICRpbnB1dCArIFwiJnk9JnBsb3Q9c2hvcnQmcj1qc29uXCI7XG4gIHZhciBwb3N0VXJsID0gZmIuY2hpbGQoYHVzZXJzLyR7ZmIuZ2V0QXV0aCgpLnVpZH0vbW92aWVzYCk7XG4gICQuZ2V0KHVybCwgZnVuY3Rpb24oZGF0YSkge1xuICAgIHBvc3RVcmwucHVzaChkYXRhKTtcbiAgICAkKCdpbnB1dFt0eXBlPVwidGV4dFwiXScpLnZhbCgnJyk7XG4gIH0pO1xufSlcblxuLyotLS0tLS0gU3luY2luZyBwcmV2aW91cyBtb3ZpZSB0YWJsZSAtLS0tLS0tKi9cblxuZmIub25BdXRoKGZ1bmN0aW9uKGF1dGhEYXRhKSB7XG4gIGlmIChhdXRoRGF0YSAmJiBhdXRoRGF0YS5wYXNzd29yZC5pc1RlbXBvcmFyeVBhc3N3b3JkKSB7XG4gICAgd2luZG93LmxvY2F0aW9uID0gJy9yZXNldF9wYXNzd29yZC5odG1sJ1xuICB9IGVsc2UgaWYgKGF1dGhEYXRhKSB7XG4gIHZhciBwb3N0VXJsID0gZmIuY2hpbGQoYHVzZXJzLyR7ZmIuZ2V0QXV0aCgpLnVpZH0vbW92aWVzYCk7XG4gICAgcG9zdFVybC5vbihcImNoaWxkX2FkZGVkXCIsIGZ1bmN0aW9uKHNuYXBzaG90KSB7XG4gICAgICBhZGRNb3ZpZURhdGEoc25hcHNob3QudmFsKCksIHNuYXBzaG90LmtleSgpKTtcbiAgICB9KVxuICB9XG59KVxuXG5mdW5jdGlvbiBhZGRNb3ZpZURhdGEoZGF0YSwgaWQpIHtcbiAgJChcIi5tb3ZpZS1jb2xsZWN0aW9uXCIpXG4gICAgLnByZXBlbmQoXCI8dHI+PC90cj5cIik7XG4gIHZhciAkdGFyZ2V0ID0gJChcIi5tb3ZpZS1jb2xsZWN0aW9uIHRyOmZpcnN0XCIpXG4gICAgLmF0dHIoXCJkYXRhLWlkXCIsIGlkKVxuICAgIC5hcHBlbmQoXCI8dGQ+PGltZyBzcmM9J1wiICsgZGF0YS5Qb3N0ZXIgKyBcIicgY2xhc3M9J3Bvc3Rlcic+PC90ZD5cIilcbiAgICAuYXBwZW5kKFwiPHRkPlwiICsgZGF0YS5UaXRsZSArIFwiPC90ZD5cIilcbiAgICAuYXBwZW5kKFwiPHRkPlwiICsgZGF0YS5ZZWFyICsgXCI8L3RkPlwiKVxuICAgIC5hcHBlbmQoXCI8dGQ+XCIgKyBkYXRhLlJhdGVkICsgXCI8L3RkPlwiKVxuICAgIC5hcHBlbmQoXCI8L3RkPjx0ZD48YnV0dG9uIHR5cGU9J3RleHQnIGNsYXNzPSdidG4gYnRuLXdhcm5pbmcgZGVsZXRlJz5SZW1vdmU8L2J1dHRvbj48L3RkPjwvdHI+XCIpO1xufVxuXG4vKi0tLS0tLSBEZWxldGUgZGF0YSBmcm9tIEZpcmViYXNlICYgVGFibGUgLS0tLS0tLSovXG5cbiQoXCIubW92aWUtY29sbGVjdGlvblwiKS5vbignY2xpY2snLCBcIi5kZWxldGVcIiwgZnVuY3Rpb24oKSB7XG4gIHZhciAkbW92ID0gJCh0aGlzKS5jbG9zZXN0KCd0cicpO1xuICB2YXIgaWQgPSAkbW92LmF0dHIoJ2RhdGEtaWQnKTtcbiAgJG1vdi5yZW1vdmUoKTtcbiAgdmFyIGRlbGV0ZVVybCA9IGZiLmNoaWxkKGB1c2Vycy8ke2ZiLmdldEF1dGgoKS51aWR9L21vdmllcy8ke2lkfWApO1xuICBkZWxldGVVcmwucmVtb3ZlKCk7XG59KVxuXG4vKi0tLS0tLSBSZWdpc3RlciBuZXcgdXNlciAtLS0tLS0tKi9cblxuJCgnLnJlZ2lzdGVyJykuY2xpY2soZnVuY3Rpb24gKCkge1xuICB2YXIgZW1haWwgPSAkKCcubG9naW4td2VsY29tZSBpbnB1dFt0eXBlPVwiZW1haWxcIl0nKS52YWwoKTtcbiAgdmFyIHBhc3N3b3JkID0gJCgnLmxvZ2luLXdlbGNvbWUgaW5wdXRbdHlwZT1cInBhc3N3b3JkXCJdJykudmFsKCk7XG4gIGZiLmNyZWF0ZVVzZXIoe1xuICAgIGVtYWlsOiBlbWFpbCxcbiAgICBwYXNzd29yZDogcGFzc3dvcmRcbiAgfSwgZnVuY3Rpb24gKGVyciwgdXNlckRhdGEpIHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICBhbGVydChlcnIudG9TdHJpbmcoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGRvTG9naW4oZW1haWwsIHBhc3N3b3JkKTtcbiAgICB9XG4gIH0pO1xuICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xufSk7XG5cbi8qLS0tLS0tIExvZ2luIHRvIERhdGFiYXNlIC0tLS0tLS0qL1xuXG4kKCcubG9naW4td2VsY29tZSBmb3JtJykuc3VibWl0KGZ1bmN0aW9uICgpIHtcbiAgdmFyIGVtYWlsID0gJCgnLmxvZ2luLXdlbGNvbWUgaW5wdXRbdHlwZT1cImVtYWlsXCJdJykudmFsKCk7XG4gIHZhciBwYXNzd29yZCA9ICQoJy5sb2dpbi13ZWxjb21lIGlucHV0W3R5cGU9XCJwYXNzd29yZFwiXScpLnZhbCgpO1xuXG4gIGRvTG9naW4oZW1haWwsIHBhc3N3b3JkKTtcbiAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbn0pO1xuXG4vKi0tLS0tLSBMb2dvdXQgb2YgRGF0YWJhc2UgLS0tLS0tLSovXG5cbiQoJy5sb2dvdXQnKS5jbGljayhmdW5jdGlvbiAoKSB7XG4gIHdpbmRvdy5sb2NhdGlvbiA9ICcvJztcbiAgZmIudW5hdXRoKCk7XG59KVxuXG4vKi0tLS0tLSBSZXNldCBwYXNzd29yZCAtLS0tLS0tKi9cblxuJCgnLnJlc2V0LXBhc3N3b3JkJykuY2xpY2soZnVuY3Rpb24gKCkge1xuICB2YXIgZW1haWwgPSAkKCcubG9naW4td2VsY29tZSBpbnB1dFt0eXBlPVwiZW1haWxcIl0nKS52YWwoKTtcbiAgZmIucmVzZXRQYXNzd29yZCh7XG4gICAgZW1haWw6IGVtYWlsXG4gIH0sIGZ1bmN0aW9uIChlcnIpIHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICBhbGVydChlcnIudG9TdHJpbmcoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGFsZXJ0KCdDaGVjayB5b3VyIGVtYWlsIScpO1xuICAgICAgd2luZG93LmxvY2F0aW9uID0gJy9yZXNldF9wYXNzd29yZC5odG1sJ1xuICAgIH1cbiAgfSk7XG59KTtcblxuLyotLS0tLS0gUmVzZXQgcGFzc3dvcmQgLS0tLS0tLSovXG5cbiQoJy50by1yZXNldC1wYXNzd29yZCBmb3JtJykuc3VibWl0KGZ1bmN0aW9uICgpIHtcbiAgdmFyIGVtYWlsID0gZmIuZ2V0QXV0aCgpLnBhc3N3b3JkLmVtYWlsO1xuICB2YXIgb2xkUHcgPSAkKCcudG8tcmVzZXQtcGFzc3dvcmQgaW5wdXQ6bnRoLWNoaWxkKDEpJykudmFsKCk7XG4gIHZhciBuZXdQdyA9ICQoJy50by1yZXNldC1wYXNzd29yZCBpbnB1dDpudGgtY2hpbGQoMiknKS52YWwoKTtcblxuICBmYi5jaGFuZ2VQYXNzd29yZCh7XG4gICAgZW1haWw6IGVtYWlsLFxuICAgIG9sZFBhc3N3b3JkOiBvbGRQdyxcbiAgICBuZXdQYXNzd29yZDogbmV3UHdcbiAgfSwgZnVuY3Rpb24oZXJyKSB7XG4gICAgaWYgKGVycikge1xuICAgICAgYWxlcnQoZXJyLnRvU3RyaW5nKCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBmYi51bmF1dGgoKTtcbiAgICAgIHdpbmRvdy5sb2NhdGlvbiA9ICcvJztcbiAgICB9XG4gIH0pO1xuXG4gIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG59KVxuXG4kKFwiLmNhbmNlbFwiKS5jbGljayhmdW5jdGlvbigpIHtcbiAgd2luZG93LmxvY2F0aW9uID0gJy9sb2dpbi5odG1sJ1xufSlcblxuLyotLS0tLS0gRnVuY3Rpb25zIC0tLS0tLS0qL1xuXG5mdW5jdGlvbiBkb0xvZ2luIChlbWFpbCwgcGFzc3dvcmQsIGNiKSB7XG4gIGZiLmF1dGhXaXRoUGFzc3dvcmQoe1xuICAgIGVtYWlsOiBlbWFpbCxcbiAgICBwYXNzd29yZDogcGFzc3dvcmRcbiAgfSwgZnVuY3Rpb24gKGVyciwgYXV0aERhdGEpIHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICBhbGVydChlcnIudG9TdHJpbmcoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHdpbmRvdy5sb2NhdGlvbiA9ICcvaG9tZS5odG1sJztcbiAgICAgIHNhdmVBdXRoRGF0YShhdXRoRGF0YSk7XG4gICAgICB0eXBlb2YgY2IgPT09ICdmdW5jdGlvbicgJiYgY2IoYXV0aERhdGEpO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHNhdmVBdXRoRGF0YShhdXRoRGF0YSkge1xuICB2YXIgcmVmID0gZmIuY2hpbGQoYHVzZXJzLyR7YXV0aERhdGEudWlkfS9wcm9maWxlYCk7XG4gIHJlZi5zZXQoYXV0aERhdGEpO1xufVxuXG5mdW5jdGlvbiBjbGVhckxvZ2luRm9ybSAoKSB7XG4gICQoJ2lucHV0W3R5cGU9XCJlbWFpbFwiXScpLnZhbCgnJyk7XG4gICQoJ2lucHV0W3R5cGU9XCJwYXNzd29yZFwiXScpLnZhbCgnJyk7XG59XG4iXX0=